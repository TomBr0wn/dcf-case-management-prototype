{# CASE OUTLINE ////////////////////////////////////////// #}
{% set caseOutlineHtml %}
  <h3 class="govuk-heading-m">Case outline</h3>
  {% include "_includes/case/details/outline-panels.njk" %}
{% endset -%}

{# DEFENDANTS ////////////////////////////////////////// #}
{% set defendantsHtml %}
  <h3 class="govuk-heading-m">Defendants</h3>
{% endset -%}

{# WITNESSES ////////////////////////////////////////// #}
{% set witnessesHtml %}
  <h3 class="govuk-heading-m">Witnesses</h3>
{% endset -%}

{# MATERIALS ////////////////////////////////////////// #}
{% set materialsHtml %}
  <h3 class="govuk-heading-m">Materials</h3>
  {% include "_includes/case/material/panel-v2.njk" %}
{% endset -%}

{# DISCLOSURE ////////////////////////////////////////// #}
{% set disclosureHtml %}
  <h3 class="govuk-heading-m">Disclosure</h3>
{% endset -%}

{{ govukTabs({
  items: [
    { label: "Case Outline", id: "case-outline", panel: { html: caseOutlineHtml } },
    { label: "Defendants",   id: "defendants",   panel: { html: defendantsHtml } },
    { label: "Witnesses",    id: "witnesses",    panel: { html: witnessesHtml } },
    { label: "Materials",    id: "materials",    panel: { html: materialsHtml } },
    { label: "Disclosure",   id: "disclosure",   panel: { html: disclosureHtml } }
  ]
}) }}

{% block pageScripts %}
<script>
(function () {
  // Enhance every tabset on the page
  document.querySelectorAll('.govuk-tabs').forEach(function (tabsRoot) {
    var tabLinks  = tabsRoot.querySelectorAll('.govuk-tabs__tab');
    var panels    = tabsRoot.querySelectorAll('.govuk-tabs__panel');
    if (!tabLinks.length || !panels.length) return;

    // Helper: activate a panel by #hash (e.g. "#materials")
    function activateByHash(hash) {
      var id = (hash || '').replace(/^#/, '');
      var targetPanel = id && tabsRoot.querySelector('#' + CSS.escape(id));
      var targetLink  = id && tabsRoot.querySelector('.govuk-tabs__tab[href="#' + CSS.escape(id) + '"]');

      // Fallback to first tab if no match
      if (!targetPanel || !targetLink) {
        targetPanel = panels[0];
        targetLink  = tabLinks[0];
        hash = '#' + targetPanel.id;
      }

      // Deactivate all
      tabLinks.forEach(function (a) {
        a.setAttribute('aria-selected', 'false');
        a.parentElement.classList.remove('govuk-tabs__list-item--selected');
      });
      panels.forEach(function (p) { p.hidden = true; });

      // Activate target
      targetLink.setAttribute('aria-selected', 'true');
      targetLink.parentElement.classList.add('govuk-tabs__list-item--selected');
      targetPanel.hidden = false;

      return hash; // the effective hash we activated
    }

    // Initial activation (use current hash if it matches this tabset)
    (function init() {
      var effective = activateByHash(location.hash);
      // If the current hash didn't belong to this tabset, we didn’t change the URL.
      // That’s fine—don’t touch history here.
    })();

    // Click: prevent default (so no native hash scroll), activate, then pushState (no jump)
    tabsRoot.addEventListener('click', function (e) {
      var link = e.target.closest('.govuk-tabs__tab');
      if (!link) return;

      e.preventDefault(); // stop native anchor scroll
      var hash = link.getAttribute('href');   // e.g. "#materials"
      activateByHash(hash);

      // Update URL without scrolling
      var url = new URL(location.href);
      url.hash = hash;
      history.pushState(null, '', url.toString());
    });

    // Back/Forward: if the new hash matches this tabset, activate it (no scroll)
    window.addEventListener('popstate', function () {
      // Only react if the hash belongs to one of this tabset's panels
      var ids = Array.prototype.map.call(panels, function (p) { return '#' + p.id; });
      if (ids.indexOf(location.hash) !== -1 || location.hash === '') {
        activateByHash(location.hash);
      }
    });
  });
})();
</script>

{% endblock %}
