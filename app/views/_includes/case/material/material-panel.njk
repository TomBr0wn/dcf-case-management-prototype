{# --- counts per document type (match your JSON) --- #}
{% set statementsCount = 0 %}
{% set exhibitsCount = 0 %}
{% set unusedNonSensitiveCount = 0 %}
{% set sensitiveCount = 0 %}

{% for m in (data.caseMaterials.Material or []) %}
  {% set t = (m.Type | lower) %}
  {% if t == 'statement' %}{% set statementsCount = statementsCount + 1 %}{% endif %}
  {% if t == 'exhibit' %}{% set exhibitsCount = exhibitsCount + 1 %}{% endif %}
  {% if t == 'unused non-sensitive' %}{% set unusedNonSensitiveCount = unusedNonSensitiveCount + 1 %}{% endif %}
  {% if t == 'sensitive' %}{% set sensitiveCount = sensitiveCount + 1 %}{% endif %}
{% endfor %}

{# helper to get a filename from a URL if Title is missing (optional) #}
{% macro filenameFromUrl(url) %}
  {% if url %}
    {{ url.split('/').pop() }}
  {% else %}
    Untitled
  {% endif %}
{% endmacro %}

{# --------- Statements --------- #}
{% set statementsHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list govuk-!-margin-top-1 govuk-!-margin-bottom-1">
    {% for m in (data.caseMaterials.Material or []) %}
      {% if (m.Type | lower) == 'statement' %}
        {% set hasAny = true %}
        <li class="govuk-!-margin-bottom-2">
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title govuk-!-margin-bottom-1">
                {% set linkText = m.Title or filenameFromUrl(m.myFileUrl) %}
                {% if m.myFileUrl %}
                  <a
                    href="#"
                    class="govuk-link js-material-link"
                    rel="noreferrer"
                    data-file-url="{{ m.myFileUrl }}"
                    data-title="{{ linkText | escape }}"
                    role="button"
                  >{{ linkText }}</a>

                  {# pass per-item + case-level meta to the viewer (structure matches buildMetaPanel) #}
                  {% set __meta__ = {
                    ItemId: m.ItemId,
                    Type: m.Type,
                    date: m.date,
                    Status: m.Status,

                    Material: {
                      Title: m.Title,
                      Reference: m.Reference,
                      ProducedbyWitnessId: m.ProducedbyWitnessId,
                      MaterialClassification: m.MaterialClassification,
                      MaterialType: m.MaterialType,
                      SentExternally: m.SentExternally,
                      RelatedParticipantId: m.RelatedParticipantId,
                      Incident: m.Incident,
                      Location: m.Location,
                      PeriodFrom: m.PeriodFrom,
                      PeriodTo: m.PeriodTo
                    },

                    RelatedMaterials: data.caseMaterials.RelatedMaterials,
                    DigitalRepresentation: data.caseMaterials.DigitalRepresentation,
                    PoliceMaterial: data.caseMaterials.PoliceMaterial,
                    CPSMaterial: data.caseMaterials.CPSMaterial
                  } %}
                  <script type="application/json" class="js-material-data">{{ __meta__ | dump | safe }}</script>

                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta govuk-!-margin-bottom-0">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread govuk-!-margin-bottom-0"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}

{# --------- Exhibits --------- #}
{% set exhibitsHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list">
    {% for m in (data.caseMaterials.Material or []) %}
      {% if (m.Type | lower) == 'exhibit' %}
        {% set hasAny = true %}
        <li>
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title">
                {% set linkText = m.Title or filenameFromUrl(m.myFileUrl) %}
                {% if m.myFileUrl %}
                  <a
                    href="#"
                    class="govuk-link js-material-link"
                    rel="noreferrer"
                    data-file-url="{{ m.myFileUrl }}"
                    data-title="{{ linkText | escape }}"
                    role="button"
                  >{{ linkText }}</a>

                  {% set __meta__ = {
                    ItemId: m.ItemId,
                    Type: m.Type,
                    date: m.date,
                    Status: m.Status,
                    Title: m.Title,
                    Reference: m.Reference,
                    ProducedbyWitnessId: m.ProducedbyWitnessId,
                    MaterialClassification: m.MaterialClassification,
                    MaterialType: m.MaterialType,
                    SentExternally: m.SentExternally,
                    RelatedParticipantId: m.RelatedParticipantId,
                    Incident: m.Incident,
                    Location: m.Location,
                    PeriodFrom: m.PeriodFrom,
                    PeriodTo: m.PeriodTo,
                    CaseLevel: {
                      caseId: data.caseMaterials.caseId,
                      caseStatus: data.caseMaterials.caseStatus,
                      RelatedMaterials: data.caseMaterials.RelatedMaterials,
                      DigitalRepresentation: data.caseMaterials.DigitalRepresentation,
                      PoliceMaterial: data.caseMaterials.PoliceMaterial,
                      CPSMaterial: data.caseMaterials.CPSMaterial
                    }
                  } %}
                  <script type="application/json" class="js-material-data">{{ __meta__ | dump | safe }}</script>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}

{# --------- Unused non-sensitive --------- #}
{% set unusedNonSensitiveHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list">
    {% for m in (data.caseMaterials.Material or []) %}
      {% if (m.Type | lower) == 'unused non-sensitive' %}
        {% set hasAny = true %}
        <li>
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title">
                {% set linkText = m.Title or filenameFromUrl(m.myFileUrl) %}
                {% if m.myFileUrl %}
                  <a
                    href="#"
                    class="govuk-link js-material-link"
                    rel="noreferrer"
                    data-file-url="{{ m.myFileUrl }}"
                    data-title="{{ linkText | escape }}"
                    role="button"
                  >{{ linkText }}</a>

                  {% set __meta__ = {
                    ItemId: m.ItemId,
                    Type: m.Type,
                    date: m.date,
                    Status: m.Status,
                    Title: m.Title,
                    Reference: m.Reference,
                    ProducedbyWitnessId: m.ProducedbyWitnessId,
                    MaterialClassification: m.MaterialClassification,
                    MaterialType: m.MaterialType,
                    SentExternally: m.SentExternally,
                    RelatedParticipantId: m.RelatedParticipantId,
                    Incident: m.Incident,
                    Location: m.Location,
                    PeriodFrom: m.PeriodFrom,
                    PeriodTo: m.PeriodTo,
                    CaseLevel: {
                      caseId: data.caseMaterials.caseId,
                      caseStatus: data.caseMaterials.caseStatus,
                      RelatedMaterials: data.caseMaterials.RelatedMaterials,
                      DigitalRepresentation: data.caseMaterials.DigitalRepresentation,
                      PoliceMaterial: data.caseMaterials.PoliceMaterial,
                      CPSMaterial: data.caseMaterials.CPSMaterial
                    }
                  } %}
                  <script type="application/json" class="js-material-data">{{ __meta__ | dump | safe }}</script>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}

{# --------- Sensitive --------- #}
{% set sensitiveHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list">
    {% for m in (data.caseMaterials.Material or []) %}
      {% if (m.Type | lower) == 'sensitive' %}
        {% set hasAny = true %}
        <li>
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title">
                {% set linkText = m.Title or filenameFromUrl(m.myFileUrl) %}
                {% if m.myFileUrl %}
                  <a
                    href="#"
                    class="govuk-link js-material-link"
                    rel="noreferrer"
                    data-file-url="{{ m.myFileUrl }}"
                    data-title="{{ linkText | escape }}"
                    role="button"
                  >{{ linkText }}</a>

                  {% set __meta__ = {
                    ItemId: m.ItemId,
                    Type: m.Type,
                    date: m.date,
                    Status: m.Status,
                    Title: m.Title,
                    Reference: m.Reference,
                    ProducedbyWitnessId: m.ProducedbyWitnessId,
                    MaterialClassification: m.MaterialClassification,
                    MaterialType: m.MaterialType,
                    SentExternally: m.SentExternally,
                    RelatedParticipantId: m.RelatedParticipantId,
                    Incident: m.Incident,
                    Location: m.Location,
                    PeriodFrom: m.PeriodFrom,
                    PeriodTo: m.PeriodTo,
                    CaseLevel: {
                      caseId: data.caseMaterials.caseId,
                      caseStatus: data.caseMaterials.caseStatus,
                      RelatedMaterials: data.caseMaterials.RelatedMaterials,
                      DigitalRepresentation: data.caseMaterials.DigitalRepresentation,
                      PoliceMaterial: data.caseMaterials.PoliceMaterial,
                      CPSMaterial: data.caseMaterials.CPSMaterial
                    }
                  } %}
                  <script type="application/json" class="js-material-data">{{ __meta__ | dump | safe }}</script>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}

{# ----- Layout ----- #}
<div class="govuk-grid-row dcf-materials-layout">
  <div class="govuk-grid-column-one-third">
    <div class="dcf-materials-panel">
      <div class="dcf-materials-header">
        <form class="dcf-materials-search" action="/materials/search" method="get" role="search">
          <label class="govuk-label" for="materials-search">Search materials</label>
          <div class="dcf-input-group">
            <input class="govuk-input dcf-input-group__input" id="materials-search" name="q" type="search">
            <button class="dcf-input-group__button" type="submit" aria-label="Search">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" width="20" height="20"><path fill="currentColor" d="M21 20.3l-4.8-4.8c.9-1.2 1.4-2.7 1.4-4.2C17.6 7 14.6 4 11 4S4.4 7 4.4 11s3 7 6.6 7c1.6 0 3.1-.5 4.2-1.4l4.8 4.8 1-1.1zM6 11c0-2.8 2.2-5 5-5s5 2.2 5 5-2.2 5-5 5-5-2.2-5-5z"/></svg>
            </button>
          </div>
        </form>
      </div>

        {{ govukAccordion({
          id: "materials-accordion",
          classes: "dcf-accordion",
          items: [
            { heading: { text: "Statements (" ~ statementsCount ~ ")" },           content: { html: statementsHtml    } },
            { heading: { text: "Exhibits (" ~ exhibitsCount ~ ")" },               content: { html: exhibitsHtml      } },
            { heading: { text: "MG forms (" ~ (mgFormsCount | default(0)) ~ ")" }, content: { html: (mgFormsHtml | default('<p class="govuk-hint">No items yet.</p>')) | safe } },
            { heading: { text: "Other material (" ~ (otherMaterialCount | default(0)) ~ ")" }, content: { html: (otherMaterialHtml | default('<p class="govuk-hint">No items yet.</p>')) | safe } },
            { heading: { text: "Unused non-sensitive (" ~ unusedNonSensitiveCount ~ ")" }, content: { html: unusedNonSensitiveHtml } },
            { heading: { text: "Sensitive (" ~ sensitiveCount ~ ")" },   content: { html: sensitiveHtml  } }
          ]
        }) }}




    </div>
  </div>

  <div class="govuk-grid-column-two-thirds">
    <div id="material-viewer" class="dcf-viewer" hidden aria-live="polite">
      <p class="govuk-body govuk-!-margin-bottom-3">
        
      </p>
    </div>
  </div> 
</div>
