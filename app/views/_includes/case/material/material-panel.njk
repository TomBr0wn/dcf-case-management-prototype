{# Statements #}
{% set statementsHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list govuk-!-margin-top-1 govuk-!-margin-bottom-1">
    {% for m in (data.caseMaterials or []) %}
      {% if (m.Type | lower) == 'statement' %}
        {% set hasAny = true %}
        <li class="govuk-!-margin-bottom-2">
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title govuk-!-margin-bottom-1">
                {% set linkText = m.Material.Title %}
                {% if m.myFileUrl %}
                  <a
                    href="{{ m.myFileUrl }}"
                    class="govuk-link js-material-link"
                    target="_blank"
                    rel="noreferrer"
                    data-file-url="{{ m.myFileUrl }}"
                  >
                    {{ linkText }}
                  </a>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta govuk-!-margin-bottom-0">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread govuk-!-margin-bottom-0"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}




{# Exhibits #}
{% set exhibitsHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list">
    {% for m in (data.caseMaterials or []) %}
      {% if (m.Type | lower) == 'exhibit' %}
        {% set hasAny = true %}
        <li>
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title">
                {% set linkText = m.Material.Title or m.DigitalRepresentation.FileName %}
                {% if m.myFileUrl %}
                  <a href="{{ m.myFileUrl }}" class="govuk-link" target="_blank" rel="noreferrer">{{ linkText }}</a>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}

{# MG forms #}
{% set mgFormsHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list">
    {% for m in (data.caseMaterials or []) %}
      {% if (m.Type | lower) == 'mg form' %}
        {% set hasAny = true %}
        <li>
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title">
                {% set linkText = m.Material.Title or m.DigitalRepresentation.FileName %}
                {% if m.myFileUrl %}
                  <a href="{{ m.myFileUrl }}" class="govuk-link" target="_blank" rel="noreferrer">{{ linkText }}</a>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}

{# Other material #}
{% set otherMaterialHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list">
    {% for m in (data.caseMaterials or []) %}
      {% if (m.Type | lower) == 'other material' %}
        {% set hasAny = true %}
        <li>
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title">
                {% set linkText = m.Material.Title or m.DigitalRepresentation.FileName %}
                {% if m.myFileUrl %}
                  <a href="{{ m.myFileUrl }}" class="govuk-link" target="_blank" rel="noreferrer">{{ linkText }}</a>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}

{# Unused non-sensitive #}
{% set unsNonSensitiveHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list">
    {% for m in (data.caseMaterials or []) %}
      {% if (m.Type | lower) == 'unused non-sensitive' %}
        {% set hasAny = true %}
        <li>
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title">
                {% set linkText = m.Material.Title or m.DigitalRepresentation.FileName %}
                {% if m.myFileUrl %}
                  <a href="{{ m.myFileUrl }}" class="govuk-link" target="_blank" rel="noreferrer">{{ linkText }}</a>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}

{# Unused sensitive #}
{% set unsSensitiveHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list">
    {% for m in (data.caseMaterials or []) %}
      {% if (m.Type | lower) == 'unused sensitive' %}
        {% set hasAny = true %}
        <li>
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title">
                {% set linkText = m.Material.Title or m.DigitalRepresentation.FileName %}
                {% if m.myFileUrl %}
                  <a href="{{ m.myFileUrl }}" class="govuk-link" target="_blank" rel="noreferrer">{{ linkText }}</a>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}

{# ----- Your existing layout, with captured HTML plugged in ----- #}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-one-third">
    <div class="dcf-materials-panel">
      <div class="dcf-materials-header">
        <form class="dcf-materials-search" action="/materials/search" method="get" role="search">
          <label class="govuk-label" for="materials-search">Search materials</label>
          <div class="dcf-input-group">
            <input class="govuk-input dcf-input-group__input" id="materials-search" name="q" type="search">
            <button class="dcf-input-group__button" type="submit" aria-label="Search">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" width="20" height="20"><path fill="currentColor" d="M21 20.3l-4.8-4.8c.9-1.2 1.4-2.7 1.4-4.2C17.6 7 14.6 4 11 4S4.4 7 4.4 11s3 7 6.6 7c1.6 0 3.1-.5 4.2-1.4l4.8 4.8 1-1.1zM6 11c0-2.8 2.2-5 5-5s5 2.2 5 5-2.2 5-5 5-5-2.2-5-5z"/></svg>
            </button>
          </div>
        </form>
      </div>

      {{ govukAccordion({
        id: "materials-accordion",
        classes: "dcf-accordion",
        items: [
          { heading: { text: "Statements" },           content: { html: statementsHtml    } },
          { heading: { text: "Exhibits" },             content: { html: exhibitsHtml      } },
          { heading: { text: "MG forms" },             content: { html: mgFormsHtml       } },
          { heading: { text: "Other material" },       content: { html: otherMaterialHtml } },
          { heading: { text: "Unused non-sensitive" }, content: { html: unsNonSensitiveHtml } },
          { heading: { text: "Unused sensitive" },     content: { html: unsSensitiveHtml  } }
        ]
      }) }}
    </div>
  </div>

  <div class="govuk-grid-column-two-thirds">
      {# Optional summary / count... #}
      {# <p class="govuk-body">Statements matched: {{ count }}</p> #}

      <div id="material-viewer" class="dcf-viewer" hidden aria-live="polite">
        <p class="govuk-body govuk-!-margin-bottom-3">
          Select a material from the list to preview it here.
        </p>
      </div>
    </div>

</div>


{% block pageScripts %}
  <script>
    (function () {
      const viewer = document.getElementById('material-viewer');
      if (!viewer) return;

      // Optional: highlight the active card
      function setActiveCard(linkEl) {
        document.querySelectorAll('.dcf-material-card--active').forEach(el => {
          el.classList.remove('dcf-material-card--active');
        });
        const card = linkEl.closest('.dcf-material-card');
        if (card) card.classList.add('dcf-material-card--active');
      }

      // Close button handler
      function wireClose() {
        const btn = viewer.querySelector('[data-action="close-viewer"]');
        if (!btn) return;
        btn.addEventListener('click', () => {
          viewer.innerHTML = '<p class="govuk-hint govuk-!-margin-bottom-3">Select a material from the list to preview it here.</p>';
          viewer.hidden = true;
          document.querySelectorAll('.dcf-material-card--active').forEach(el => {
            el.classList.remove('dcf-material-card--active');
          });
        });
      }

      // Intercept clicks on any link with data-file-url
      document.addEventListener('click', function (e) {
        const link = e.target.closest('a[data-file-url]');
        if (!link) return;

        // JS-enhanced: show in viewer instead of opening a new tab
        e.preventDefault();

        const url = link.getAttribute('data-file-url') || link.href;
        const title = link.textContent?.trim() || 'Selected file';

        // Very simple file-type check to change messaging for non-PDFs
        const isPDF = /\.pdf(\?|#|$)/i.test(url);

        viewer.hidden = false;
        viewer.setAttribute('tabindex', '-1'); // allow focus for screenreaders
        viewer.innerHTML = `
          <div class="govuk-button-group govuk-!-margin-bottom-2">
            <button class="govuk-button govuk-button--secondary" data-action="close-viewer" type="button">
              Close preview
            </button>
            <a href="${url}" target="_blank" rel="noreferrer" class="govuk-link govuk-!-margin-left-3">
              Open in a new tab
            </a>
            <span class="govuk-hint govuk-!-margin-left-3">${title}</span>
          </div>

          ${isPDF
            ? `<iframe
                  class="dcf-viewer__frame"
                  src="${url}"
                  title="Preview of ${title}"
                  loading="lazy"
                  referrerpolicy="no-referrer"
                ></iframe>`
            : `<div class="govuk-inset-text govuk-!-margin-bottom-2">
                This file type may not preview inline. You can <a class="govuk-link" href="${url}" target="_blank" rel="noreferrer">open it in a new tab</a>.
              </div>
              <iframe
                class="dcf-viewer__frame"
                src="${url}"
                title="Preview of ${title}"
                loading="lazy"
                referrerpolicy="no-referrer"
              ></iframe>`
          }
        `;

        setActiveCard(link);
        wireClose();
        viewer.focus({ preventScroll: false }); // move attention to the preview
      }, false);
    })();
  </script>
{% endblock %}