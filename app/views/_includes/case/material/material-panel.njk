{# --- counts per document type --- #}
{% set statementsCount = 0 %}
{% set exhibitsCount = 0 %}
{% set mgFormsCount = 0 %}
{% set otherMaterialCount = 0 %}
{% set unsNonSensitiveCount = 0 %}
{% set unsSensitiveCount = 0 %}

{% for m in (data.caseMaterials or []) %}
  {% set t = (m.Type | lower) %}
  {% if t == 'statement' %}{% set statementsCount = statementsCount + 1 %}{% endif %}
  {% if t == 'exhibit' %}{% set exhibitsCount = exhibitsCount + 1 %}{% endif %}
  {% if t == 'mg form' %}{% set mgFormsCount = mgFormsCount + 1 %}{% endif %}
  {% if t == 'other material' %}{% set otherMaterialCount = otherMaterialCount + 1 %}{% endif %}
  {% if t == 'unused non-sensitive' %}{% set unsNonSensitiveCount = unsNonSensitiveCount + 1 %}{% endif %}
  {% if t == 'unused sensitive' %}{% set unsSensitiveCount = unsSensitiveCount + 1 %}{% endif %}
{% endfor %}


{# Statements #}
{% set statementsHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list govuk-!-margin-top-1 govuk-!-margin-bottom-1">
    {% for m in (data.caseMaterials or []) %}
      {% if (m.Type | lower) == 'statement' %}
        {% set hasAny = true %}
        <li class="govuk-!-margin-bottom-2">
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title govuk-!-margin-bottom-1">
                {% set linkText = m.Material.Title or m.DigitalRepresentation.FileName %}
                {% if m.myFileUrl %}
                  <a
                    href="{{ m.myFileUrl }}"
                    class="govuk-link js-material-link"
                    target="_blank"
                    rel="noreferrer"
                    data-file-url="{{ m.myFileUrl }}"
                    data-title="{{ linkText | escape }}"
                  >{{ linkText }}</a>
                  

                  {# pass meta (no myFileUrl) for the viewer meta panel #}
                  {% set __meta__ = {
                    ItemId: m.ItemId,
                    Type: m.Type,
                    date: m.date,
                    Status: m.Status,
                    Material: m.Material,
                    RelatedMaterials: m.RelatedMaterials,
                    DigitalRepresentation: m.DigitalRepresentation,
                    PoliceMaterial: m.PoliceMaterial,
                    CPSMaterial: m.CPSMaterial
                  } %}
                  <script type="application/json" class="js-material-data">{{ __meta__ | dump | safe }}</script>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta govuk-!-margin-bottom-0">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread govuk-!-margin-bottom-0"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}


{# Exhibits #}
{% set exhibitsHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list">
    {% for m in (data.caseMaterials or []) %}
      {% if (m.Type | lower) == 'exhibit' %}
        {% set hasAny = true %}
        <li>
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title">
                {% set linkText = m.Material.Title or m.DigitalRepresentation.FileName %}
                {% if m.myFileUrl %}
                  <a
                    href="{{ m.myFileUrl }}"
                    class="govuk-link js-material-link"
                    target="_blank"
                    rel="noreferrer"
                    data-file-url="{{ m.myFileUrl }}"
                    data-title="{{ linkText | escape }}"
                  >{{ linkText }}</a>

                  {% set __meta__ = {
                    ItemId: m.ItemId,
                    Type: m.Type,
                    date: m.date,
                    Status: m.Status,
                    Material: m.Material,
                    RelatedMaterials: m.RelatedMaterials,
                    DigitalRepresentation: m.DigitalRepresentation,
                    PoliceMaterial: m.PoliceMaterial,
                    CPSMaterial: m.CPSMaterial
                  } %}
                  <script type="application/json" class="js-material-data">{{ __meta__ | dump | safe }}</script>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}


{# MG forms #}
{% set mgFormsHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list">
    {% for m in (data.caseMaterials or []) %}
      {% if (m.Type | lower) == 'mg form' %}
        {% set hasAny = true %}
        <li>
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title">
                {% set linkText = m.Material.Title or m.DigitalRepresentation.FileName %}
                {% if m.myFileUrl %}
                  <a
                    href="{{ m.myFileUrl }}"
                    class="govuk-link js-material-link"
                    target="_blank"
                    rel="noreferrer"
                    data-file-url="{{ m.myFileUrl }}"
                    data-title="{{ linkText | escape }}"
                  >{{ linkText }}</a>

                  {% set __meta__ = {
                    ItemId: m.ItemId,
                    Type: m.Type,
                    date: m.date,
                    Status: m.Status,
                    Material: m.Material,
                    RelatedMaterials: m.RelatedMaterials,
                    DigitalRepresentation: m.DigitalRepresentation,
                    PoliceMaterial: m.PoliceMaterial,
                    CPSMaterial: m.CPSMaterial
                  } %}
                  <script type="application/json" class="js-material-data">{{ __meta__ | dump | safe }}</script>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}


{# Other material #}
{% set otherMaterialHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list">
    {% for m in (data.caseMaterials or []) %}
      {% if (m.Type | lower) == 'other material' %}
        {% set hasAny = true %}
        <li>
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title">
                {% set linkText = m.Material.Title or m.DigitalRepresentation.FileName %}
                {% if m.myFileUrl %}
                  <a
                    href="{{ m.myFileUrl }}"
                    class="govuk-link js-material-link"
                    target="_blank"
                    rel="noreferrer"
                    data-file-url="{{ m.myFileUrl }}"
                    data-title="{{ linkText | escape }}"
                  >{{ linkText }}</a>

                  {% set __meta__ = {
                    ItemId: m.ItemId,
                    Type: m.Type,
                    date: m.date,
                    Status: m.Status,
                    Material: m.Material,
                    RelatedMaterials: m.RelatedMaterials,
                    DigitalRepresentation: m.DigitalRepresentation,
                    PoliceMaterial: m.PoliceMaterial,
                    CPSMaterial: m.CPSMaterial
                  } %}
                  <script type="application/json" class="js-material-data">{{ __meta__ | dump | safe }}</script>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}


{# Unused non-sensitive #}
{% set unsNonSensitiveHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list">
    {% for m in (data.caseMaterials or []) %}
      {% if (m.Type | lower) == 'unused non-sensitive' %}
        {% set hasAny = true %}
        <li>
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title">
                {% set linkText = m.Material.Title or m.DigitalRepresentation.FileName %}
                {% if m.myFileUrl %}
                  <a
                    href="{{ m.myFileUrl }}"
                    class="govuk-link js-material-link"
                    target="_blank"
                    rel="noreferrer"
                    data-file-url="{{ m.myFileUrl }}"
                    data-title="{{ linkText | escape }}"
                  >{{ linkText }}</a>

                  {% set __meta__ = {
                    ItemId: m.ItemId,
                    Type: m.Type,
                    date: m.date,
                    Status: m.Status,
                    Material: m.Material,
                    RelatedMaterials: m.RelatedMaterials,
                    DigitalRepresentation: m.DigitalRepresentation,
                    PoliceMaterial: m.PoliceMaterial,
                    CPSMaterial: m.CPSMaterial
                  } %}
                  <script type="application/json" class="js-material-data">{{ __meta__ | dump | safe }}</script>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}


{# Unused sensitive #}
{% set unsSensitiveHtml %}
  {% set hasAny = false %}
  <ul class="dcf-material-list">
    {% for m in (data.caseMaterials or []) %}
      {% if (m.Type | lower) == 'unused sensitive' %}
        {% set hasAny = true %}
        <li>
          <article class="dcf-material-card">
            <div class="dcf-material-card__main">
              {% if m.Status %}<span class="dcf-material-card__badge">{{ m.Status }}</span>{% endif %}
              <h3 class="dcf-material-card__title">
                {% set linkText = m.Material.Title or m.DigitalRepresentation.FileName %}
                {% if m.myFileUrl %}
                  <a
                    href="{{ m.myFileUrl }}"
                    class="govuk-link js-material-link"
                    target="_blank"
                    rel="noreferrer"
                    data-file-url="{{ m.myFileUrl }}"
                    data-title="{{ linkText | escape }}"
                  >{{ linkText }}</a>

                  {% set __meta__ = {
                    ItemId: m.ItemId,
                    Type: m.Type,
                    date: m.date,
                    Status: m.Status,
                    Material: m.Material,
                    RelatedMaterials: m.RelatedMaterials,
                    DigitalRepresentation: m.DigitalRepresentation,
                    PoliceMaterial: m.PoliceMaterial,
                    CPSMaterial: m.CPSMaterial
                  } %}
                  <script type="application/json" class="js-material-data">{{ __meta__ | dump | safe }}</script>
                {% else %}
                  {{ linkText }}
                {% endif %}
              </h3>
              {% if m.date %}<p class="dcf-material-card__meta">Date: {{ m.date }}</p>{% endif %}
            </div>
            <div class="dcf-material-card__comment is-unread"></div>
          </article>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endset %}


{# ----- Layout (unchanged) ----- #}
<div class="govuk-grid-row dcf-materials-layout">
  <div class="govuk-grid-column-one-third">
    <div class="dcf-materials-panel">
      <div class="dcf-materials-header">
        <form class="dcf-materials-search" action="/materials/search" method="get" role="search">
          <label class="govuk-label" for="materials-search">Search materials</label>
          <div class="dcf-input-group">
            <input class="govuk-input dcf-input-group__input" id="materials-search" name="q" type="search">
            <button class="dcf-input-group__button" type="submit" aria-label="Search">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" width="20" height="20"><path fill="currentColor" d="M21 20.3l-4.8-4.8c.9-1.2 1.4-2.7 1.4-4.2C17.6 7 14.6 4 11 4S4.4 7 4.4 11s3 7 6.6 7c1.6 0 3.1-.5 4.2-1.4l4.8 4.8 1-1.1zM6 11c0-2.8 2.2-5 5-5s5 2.2 5 5-2.2 5-5 5-5-2.2-5-5z"/></svg>
            </button>
          </div>
        </form>
      </div>

        {{ govukAccordion({
          id: "materials-accordion",
          classes: "dcf-accordion",
          items: [
            { heading: { text: "Statements (" ~ statementsCount ~ ")" },           content: { html: statementsHtml    } },
            { heading: { text: "Exhibits (" ~ exhibitsCount ~ ")" },               content: { html: exhibitsHtml      } },
            { heading: { text: "MG forms (" ~ mgFormsCount ~ ")" },                content: { html: mgFormsHtml       } },
            { heading: { text: "Other material (" ~ otherMaterialCount ~ ")" },    content: { html: otherMaterialHtml } },
            { heading: { text: "Unused non-sensitive (" ~ unsNonSensitiveCount ~ ")" }, content: { html: unsNonSensitiveHtml } },
            { heading: { text: "Unused sensitive (" ~ unsSensitiveCount ~ ")" },   content: { html: unsSensitiveHtml  } }
          ]
        }) }}

    </div>
  </div>

  <div class="govuk-grid-column-two-thirds">
    <div id="material-viewer" class="dcf-viewer" hidden aria-live="polite">
      <p class="govuk-body govuk-!-margin-bottom-3">
        Select a material from the list to preview it here.
      </p>
    </div>
  </div>
</div>
