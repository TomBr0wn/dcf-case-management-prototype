{% from "govuk/components/accordion/macro.njk" import govukAccordion %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}


{# expects: params.caseMaterials = { caseId, caseStatus, Material: [...] , RelatedMaterials, DigitalRepresentation, PoliceMaterial, CPSMaterial } #}

{# ---------- data + helpers ---------- #}
{% set cm     = params.caseMaterials or {} %}
{% set items  = cm.Material or [] %}

{% set statementsCount = 0 %}
{% set exhibitsCount = 0 %}
{% set unsNonSensitiveCount = 0 %}
{% set sensitiveCount = 0 %}
{% set otherCount = 0 %}
{% set mgFormsCount = 0 %}
{% for m in items %}
  {% set t = (m.Type | lower) %}
  {% if t == 'statement' %}{% set statementsCount = statementsCount + 1 %}{% endif %}
  {% if t == 'exhibit' %}{% set exhibitsCount = exhibitsCount + 1 %}{% endif %}
  {% if t == 'unused non-sensitive' %}{% set unsNonSensitiveCount = unsNonSensitiveCount + 1 %}{% endif %}
  {% if t == 'sensitive' %}{% set sensitiveCount = sensitiveCount + 1 %}{% endif %}
  {% if t == 'other material' %}{% set otherCount = otherCount + 1 %}{% endif %}
  {% if t == 'mg forms' %}{% set mgFormsCount = mgFormsCount + 1 %}{% endif %}
{% endfor %}

{% macro filenameFromUrl(url) %}
  {% if url %}{{ url.split('/').pop() }}{% else %}Untitled{% endif %}
{% endmacro %}

{# Single card renderer so meta stays consistent for all sections #}
{% macro renderCard(m, cm) %}
  {% set linkText = m.Title or filenameFromUrl(m.myFileUrl) %}
  <article
    class="dcf-material-card"
    data-item-id="{{ m.ItemId }}"
    {# NEW: expose the date to JS for sorting #}
    {% if m.date %}data-material-date="{{ m.date }}"{% endif %}
  >
    <div class="dcf-material-card__main">

      {# --- status badge (show only when status is exactly "New") --- #}
      {% set _status = m.materialStatus  %}
        {% if _status and (_status | lower) == 'new' %}
          <span class="dcf-material-card__badge">New</span>
        {% endif %}
        
      <h3 class="dcf-material-card__title govuk-!-margin-bottom-1">
        {% if m.myFileUrl %}
          <a
            href="#"
            class="govuk-link js-material-link"
            rel="noreferrer"
            role="button"
            data-file-url="{{ m.myFileUrl }}"
            data-title="{{ linkText }}"
          >{{ linkText }}</a>
 
          {# meta must match buildMetaPanel(meta) #}
          {% set __meta__ = {
            ItemId: m.ItemId,
            Type: m.Type,
            date: m.date,
            Status: m.Status,

            Material: {
              Title: m.Title,
              myFileUrl: m.myFileUrl,
              MaterialStatus: m.materialStatus,
              Reference: m.Reference,
              ProducedbyWitnessId: m.ProducedbyWitnessId,
              MaterialClassification: m.MaterialClassification,
              MaterialType: m.MaterialType,
              SentExternally: m.SentExternally,
              RelatedParticipantId: m.RelatedParticipantId,
              Incident: m.Incident,
              Location: m.Location,
              PeriodFrom: m.PeriodFrom,
              PeriodTo: m.PeriodTo
            },


            RelatedMaterials: cm.RelatedMaterials,
            DigitalRepresentation: cm.DigitalRepresentation,
            PoliceMaterial: cm.PoliceMaterial,
            CPSMaterial: cm.CPSMaterial
          } %}
          <script type="application/json" class="js-material-data">{{ __meta__ | dump | safe }}</script>
        {% else %}
          {{ linkText }}
        {% endif %}
      </h3>
      {% if m.date %}<p class="dcf-material-card__meta govuk-!-margin-bottom-0">Date: {{ m.date }}</p>{% endif %}
    </div>
    <div class="dcf-material-card__comment is-unread govuk-!-margin-bottom-0"></div>
  </article>
{% endmacro %}

{% macro renderSection(typeLower, addListMargins=false) %}
  {% set hasAny = false %}
  <ul class="dcf-material-list{% if addListMargins %} govuk-!-margin-top-1 govuk-!-margin-bottom-1{% endif %}">
    {% for m in items %}
      {% if (m.Type | lower) == typeLower %}
        {% set hasAny = true %}
        <li class="govuk-!-margin-bottom-2">{{ renderCard(m, cm) }}</li>
      {% endif %}
    {% endfor %}
  </ul>
  {% if not hasAny %}<p class="govuk-hint">No items yet.</p>{% endif %}
{% endmacro %}

{# ---------- Layout ---------- #}
<div class="govuk-grid-row dcf-materials-layout">
  <div class="govuk-grid-column-one-quarter">
    <div class="dcf-materials-panel">
      <div class="dcf-materials-header">
        <form class="dcf-materials-search" action="/materials/search" method="get" role="search">
          <label class="govuk-label govuk-!-font-weight-bold" for="materials-search">Search documents</label>

          {# {{ govukRadios({
            classes: "govuk-radios--small",
            name: "caseOrMaterialSearch",
            fieldset: {
              legend: {
                text: " ",
                isPageHeading: false,
                classes: "govuk-fieldset__legend--s"
              }
            },
            items: [
              {
                value: "materials",
                text: "Materials",
                checked: true
              },
              {
                value: "case",
                text: "Case"
              }
            ]
          }) }} #}

          <div class="dcf-input-group">
            <input class="govuk-input dcf-input-group__input" id="materials-search" name="q" type="search">
            <button class="dcf-input-group__button" type="submit" aria-label="Search">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" width="20" height="20">
                <path fill="currentColor" d="M21 20.3l-4.8-4.8c.9-1.2 1.4-2.7 1.4-4.2C17.6 7 14.6 4 11 4S4.4 7 4.4 11s3 7 6.6 7c1.6 0 3.1-.5 4.2-1.4l4.8 4.8 1-1.1zM6 11c0-2.8 2.2-5 5-5s5 2.2 5 5-2.2 5-5 5-5-2.2-5-5z"/>
              </svg>
            </button>
          </div>

          <input type="hidden" name="caseId" value="{{ params.caseMaterials.caseId }}">
        </form>
      </div>


      {{ govukAccordion({
        id: "materials-accordion",
        classes: "dcf-accordion",
        items: [
          { heading: { text: "Statements (" ~ statementsCount ~ ")" },           content: { html: renderSection('statement', true) } },
          { heading: { text: "Exhibits (" ~ exhibitsCount ~ ")" },               content: { html: renderSection('exhibit')        } },
          { heading: { text: "MG forms (" ~ mgFormsCount ~ ")" },               content: { html: renderSection('mg forms')        } },
          { heading: { text: "Other material (" ~ otherCount ~ ")" },               content: { html: renderSection('other material')        } },
          { heading: { text: "Unused non-sensitive (" ~ unsNonSensitiveCount ~ ")" }, content: { html: renderSection('unused non-sensitive') } },
          { heading: { text: "Sensitive (" ~ sensitiveCount ~ ")" },             content: { html: renderSection('sensitive')      } }
        ]
      }) }}
    </div>
  </div>

  <div class="govuk-grid-column-three-quarters">

    {# --- SEARCH STATUS (shown only after a search submit) --- #}
    <div id="search-status" class="govuk-!-margin-bottom-3" aria-live="polite" hidden>
      <div data-zero>
        <div class="dcf-search-meta govuk-!-margin-bottom-0">
          No results for “<span data-search-term></span>”.
        </div>
      </div>
      
      <div data-some hidden>
        <div class="dcf-search-status-row">
          <p class="dcf-search-meta dcf-search-status-row__meta">
            <strong><span data-search-count>0</span></strong>
            results for “<span data-search-term></span>”
            <span data-role="back-to-documents-sep" hidden> | </span>
            <a href="#" class="govuk-link" data-action="back-to-documents" hidden>Back to documents</a>
          </p>

          <div class="dcf-search-order dcf-search-status-row__order"
              aria-label="Search result sort options">
            <span class="dcf-search-order__label"><b>Sort by: </b> </span>

            <a href="#"
              class="govuk-link dcf-search-order__link"
              data-sort-key="date"
              aria-pressed="true">
              Date added
            </a>

            <span aria-hidden="true" class="dcf-search-order__separator">&nbsp;|&nbsp;</span>

            <a href="#"
              class="govuk-link dcf-search-order__link"
              data-sort-key="results"
              aria-pressed="false">
              Results per document
            </a>
          </div>
        </div>
      </div>

    </div>

    <div id="material-viewer" class="dcf-viewer" hidden aria-live="polite">
      <p class="govuk-body govuk-!-margin-bottom-3">Select a material from the list to preview it here.</p>
    </div>
  </div>
</div>
