{% extends "layouts/main.html" %}
{% set navId = 'cases' %}
{% set secondaryNavId = 'materials' %}
{# {% set pageName = 'Materials' %} #}
{# {% set pageName = "Material (:total)" | replace(':total', _case.materials.length) %} #}

{% set defendantsValue %}
  {{_case.defendants[0].firstName}} {{_case.defendants[0].lastName}}
  {% if _case.defendants.length > 1 %}
    and {{_case.defendants.length - 1}} more
  {% endif %}
{% endset %}

{% set pageName = defendantsValue %}

{# {% block beforeContent %}
  {% include "_includes/case/identity-bar.njk" %}
{% endblock %} #}

{% block content %}
  {% include "_includes/success-banner.njk" %}
  {% include "_includes/case/dcf-navigation.njk" %}


    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">


        <div class="moj-page-header-actions">
          <div class="moj-page-header-actions__title">
            <span class="govuk-caption-m">{{_case.reference}}</span>
            <h1 class="govuk-heading-m">{{defendantsValue}}</h1>
          </div>
          <div class="moj-page-header-actions__actions">
            <div class="moj-button-group moj-button-group--inline">
              <button type="submit" class="govuk-button govuk-button--primary" data-module="govuk-button">
                Complete triage
              </button>
              <button type="submit" class="govuk-button govuk-button--secondary" data-module="govuk-button">
                Share collection
              </button>
            </div>
          </div>
        </div>


        {# <h1 class="govuk-heading-l">{{pageName}}</h1> #}
        {% include "_includes/case/material/main-tabs.njk" %}
         
      </div>
    </div>

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        
      </div>
    </div>


{% endblock %}

{% block pageScripts %}
<script>
(function () {
  var viewer = document.getElementById('material-viewer');
  var layout = document.querySelector('.dcf-materials-layout');
  if (!viewer) return;

  /* ---------- helpers ---------- */

  function getMaterialJSONFromLink(link) {
    var card = link.closest('.dcf-material-card');
    if (!card) return null;
    var tag = card.querySelector('script.js-material-data[type="application/json"]');
    if (!tag) return null;
    try { return JSON.parse(tag.textContent); } catch (e) { return null; }
  }

  function esc(s) {
    return (s == null ? '' : String(s))
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  function rowsHTML(obj, mapping) {
    return mapping.map(function (m) {
      var v = (m.get ? m.get(obj) : obj && obj[m.key]);
      if (v == null || v === '' || (Array.isArray(v) && v.length === 0)) return '';
      var valHTML = (m.render ? m.render(v) : esc(v));
      return (
        '<div class="govuk-summary-list__row">' +
          '<dt class="govuk-summary-list__key">' + esc(m.label) + '</dt>' +
          '<dd class="govuk-summary-list__value">' + valHTML + '</dd>' +
        '</div>'
      );
    }).join('');
  }

  function sectionHTML(title, rows) {
    if (!rows) return '';
    return (
      '<h3 class="govuk-heading-s govuk-!-margin-top-3 govuk-!-margin-bottom-1">' + esc(title) + '</h3>' +
      '<dl class="govuk-summary-list govuk-!-margin-bottom-2">' + rows + '</dl>'
    );
  }

  function buildMetaPanel(meta) {
    // Unique id for collapsible body
    var bodyId = 'meta-' + esc((meta.ItemId || meta.Material && meta.Material.Reference || Date.now()).toString()).replace(/[^a-zA-Z0-9_-]/g,'-');

    // Sections
    var mat = meta.Material || {};
    var rel = meta.RelatedMaterials || {};
    var dig = meta.DigitalRepresentation || {};
    var pol = meta.PoliceMaterial || {};
    var cps = meta.CPSMaterial || {};
    var insp = pol.Inspection || {};

    var materialRows = rowsHTML(mat, [
      { key:'Title',                  label:'Title' },
      { key:'Reference',              label:'Reference' },
      { key:'ProducedbyWitnessId',    label:'Produced by (witness id)' },
      { key:'MaterialClassification', label:'Material classification' },
      { key:'MaterialType',           label:'Material type' },
      { key:'SentExternally',         label:'Sent externally' },
      { key:'RelatedParticipantId',   label:'Related participant id' },
      { key:'Incident',               label:'Incident' },
      { key:'Location',               label:'Location' },
      { key:'PeriodFrom',             label:'Period from' },
      { key:'PeriodTo',               label:'Period to' }
    ]);

    var relatedRows = rowsHTML(rel, [
      { key:'RelatesToItem',   label:'Relates to item' },
      { key:'RelatedItemId',   label:'Related item id' },
      { key:'RelationshipType',label:'Relationship type' }
    ]);

    var digitalRows = rowsHTML(dig, [
      { key:'FileName',             label:'File name' },
      { key:'Document',             label:'Document' },
      { key:'ExternalFileLocation', label:'External file location' },
      { key:'ExternalFileURL',      label:'External file URL', render: function (v) {
          if (v === '#' || v === '') return '—';
          return '<a class="govuk-link" href="' + esc(v) + '" target="_blank" rel="noreferrer">' + esc(v) + '</a>';
        }},
      { key:'DigitalSignature',     label:'Digital signature' }
    ]);

    var policeRows = rowsHTML(pol, [
      { key:'DisclosureStatus',               label:'Disclosure status' },
      { key:'RationaleForDisclosureDecision', label:'Rationale for disclosure decision' },
      { key:'Rebuttable',                     label:'Rebuttable' },
      { key:'SensitivityRationale',           label:'Sensitivity rationale' },
      { key:'Description',                    label:'Description' },
      { key:'Exceptions',                     label:'Exceptions', render: function (arr) {
          if (!Array.isArray(arr) || !arr.length) return '—';
          return '<ul class="govuk-list govuk-list--bullet govuk-!-margin-bottom-0">' +
                   arr.map(function (x){ return '<li>' + esc(x) + '</li>'; }).join('') +
                 '</ul>';
        }},
      { label:'Inspection date', get: function(){ return insp.DateOfInspection; } },
      { label:'Inspected by',   get: function(){ return insp.InspectedBy; } }
    ]);

    var cpsRows = rowsHTML(cps, [
      { key:'DisclosureStatus',               label:'Disclosure status' },
      { key:'RationaleForDisclosureDecision', label:'Rationale for disclosure decision' },
      { key:'SensitivityDispute',             label:'Sensitivity dispute' }
    ]);

    // Meta bar with actions (no chips)
    var metaBar =
      '<div class="dcf-viewer__meta-bar">' +
        '<div class="dcf-meta-actions">' +
          '<a href="#" class="govuk-link js-meta-toggle" data-action="toggle-meta" aria-expanded="true" aria-controls="' + bodyId + '">Hide details <i class="fa-sharp fa-solid fa-chevron-down"></i></a>' +
          '<a href="#" class="govuk-button govuk-button--secondary dcf-meta-secondary" data-action="reclassify">Reclassify</a>' +
        '</div>' +
      '</div>';

    return '' +
      '<div class="dcf-viewer__meta">' +
        metaBar +
        '<div id="' + bodyId + '" class="dcf-viewer__meta-body">' +
          sectionHTML('Material',               materialRows) +
          sectionHTML('Related materials',      relatedRows)  +
          sectionHTML('Digital representation', digitalRows)  +
          sectionHTML('Police material',        policeRows)   +
          sectionHTML('CPS material',           cpsRows)      +
        '</div>' +
      '</div>';
  }

  function setActiveCard(linkEl) {
    document.querySelectorAll('.dcf-material-card--active')
      .forEach(function (el) { el.classList.remove('dcf-material-card--active'); });
    var card = linkEl.closest('.dcf-material-card');
    if (card) card.classList.add('dcf-material-card--active');
  }

  /* ---------- open preview ---------- */

  document.addEventListener('click', function (e) {
    var link = e.target.closest('a.js-material-link[data-file-url]');
    if (!link) return;

    e.preventDefault();

    var meta  = getMaterialJSONFromLink(link) || {};
    var url   = link.getAttribute('data-file-url') || link.href;
    var title = link.getAttribute('data-title') || (link.textContent || '').trim() || 'Selected file';
    var isPDF = /\.pdf(\?|#|$)/i.test(url);

    var toolbar =
      '<div class="dcf-viewer__toolbar govuk-!-margin-bottom-4">' +
        '<a href="#" class="govuk-link" data-action="close-viewer">Close preview</a>' +
        '<span aria-hidden="true" class="govuk-!-margin-horizontal-2">&nbsp;|&nbsp;</span>' +
        '<a href="#" class="govuk-link" data-action="toggle-full" aria-pressed="false">View full width</a>' +
        '<span class="govuk-!-margin-left-3">' + esc(title) + '</span>' +
      '</div>';

    var metaBar = buildMetaPanel(meta);

    var iframe = isPDF
      ? '<iframe class="dcf-viewer__frame" src="' + esc(url) + '" title="Preview of ' + esc(title) + '" loading="lazy" referrerpolicy="no-referrer"></iframe>'
      : '<div class="govuk-inset-text govuk-!-margin-bottom-2">This file type may not preview inline. You can ' +
          '<a class="govuk-link" href="' + esc(url) + '" target="_blank" rel="noreferrer">open it in a new tab</a>.' +
        '</div>' +
        '<iframe class="dcf-viewer__frame" src="' + esc(url) + '" title="Preview of ' + esc(title) + '" loading="lazy" referrerpolicy="no-referrer"></iframe>';

    viewer.hidden = false;
    viewer.setAttribute('tabindex', '-1');
    viewer.innerHTML = toolbar + metaBar + iframe;

    setActiveCard(link);
    viewer.focus({ preventScroll: false });
  }, false);

  /* ---------- toolbar + meta actions ---------- */

  viewer.addEventListener('click', function (e) {
    var a = e.target.closest('a[data-action]');
    if (!a) return;

    e.preventDefault();
    var action = a.getAttribute('data-action');

    if (action === 'close-viewer') {
      viewer.innerHTML = '<p class="govuk-hint govuk-!-margin-bottom-3">Select a material from the list to preview it here.</p>';
      viewer.hidden = true;
      if (layout) layout.classList.remove('is-full');
      document.querySelectorAll('.dcf-material-card--active').forEach(function (el) { el.classList.remove('dcf-material-card--active'); });
      return;
    }

    if (action === 'toggle-full') {
      if (!layout) return;
      var on = layout.classList.toggle('is-full');
      a.textContent = on ? 'Exit full width' : 'View full width';
      a.setAttribute('aria-pressed', String(on));
      viewer.focus({ preventScroll: true });
      return;
    }

    if (action === 'toggle-meta') {
      var targetId = a.getAttribute('aria-controls');
      var body = targetId && document.getElementById(targetId);
      if (!body) return;
      var expanded = a.getAttribute('aria-expanded') === 'true';
      body.hidden = expanded;
      a.setAttribute('aria-expanded', String(!expanded));
      a.textContent = expanded ? 'Show details' : 'Hide details';
      return;
    }

    if (action === 'reclassify') {
      // Hook your real action here
      console.log('Reclassify clicked');
      return;
    }
  }, false);
})();
</script>
{% endblock %}

